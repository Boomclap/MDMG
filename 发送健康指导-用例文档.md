# 发送健康指导 - 用例文档

## 用例基本信息

| 项目 | 内容 |
|------|------|
| **用例名称** | 发送健康指导 |
| **简要描述** | 医生基于患者提交的健康问卷和体检报告，通过选择指导模板、配置健康建议、编辑个性化内容，最终发送完整的健康指导给患者 |
| **参与者** | 医生（主要参与者） |
| **涉众** | 医生、患者、健康指导系统、模板管理系统 |
| **相关用例** | 查看患者问卷详情、查看体检报告、管理健康指导模板、接收健康指导、查看健康指导记录 |

## 前置条件

• 医生已完成小程序登录认证，具有健康指导权限
• 患者已提交健康问卷，医生已查看问卷详情
• 系统中存在可用的健康指导模板库
• 医生与患者之间已建立医患关系（分配关系）
• 患者问卷状态为"待处理"，尚未提供健康指导

## 后置条件

• 健康指导内容成功发送给患者，患者可在小程序中查看
• 问卷消息状态更新为"已回复"，医生消息列表中显示已处理
• 系统记录健康指导的发送时间、内容和医生信息
• 生成健康指导记录，支持后续查看和追踪
• 患者收到健康指导通知，可查看详细指导内容

## 基本事件流

1. **进入健康指导编辑器**
   - 医生在问卷详情页面点击"提供健康指导"按钮
   - 系统跳转到健康指导编辑器页面（doctor-guidance-editor.html）
   - 页面显示顶部导航栏，包含返回按钮、问卷查看按钮、体检报告查看按钮

2. **显示患者信息**
   - 系统在页面顶部显示患者基本信息卡片
   - 包含患者头像（姓氏首字母，渐变色背景）、姓名、性别、年龄、问卷类型
   - 信息以卡片形式呈现，带有用户图标标识

3. **第一步：选择指导模板**
   - 系统显示可用的健康指导模板列表，以横向滚动形式展示
   - 模板包括：糖尿病饮食指导、糖尿病运动指导、高血压用药指导、一般健康建议等
   - 医生点击选择合适的模板，被选中的模板高亮显示（蓝色背景）
   - 系统根据选择的模板加载对应的建议配置项
   - **支持多模板组合使用**：医生可以在不同模板间切换，每个模板的选择状态独立保存

4. **第二步：选择健康建议**
   - 系统根据选中的模板动态生成建议选择区域
   - 建议类型包括：
     * **文本建议**：可多选的文本建议项，如"减少碳水化合物摄入"
     * **分组多选建议**：按类别分组的多选项，如"饮食控制方式"
     * **单选建议**：互斥选择项，如"复诊频率"、"血糖监测频率"
     * **数值参数建议**：可配置数值的建议，如"每日热量摄入"、"碳水化合物比例"

5. **建议项交互操作**
   - **文本建议选择**：医生点击复选框选择/取消选择建议项
   - **分组建议选择**：在分组标题下选择多个相关建议
   - **单选建议选择**：点击单选按钮，同组内其他选项自动取消
   - **数值参数配置**：
     * 点击数值输入框直接输入数值
     * 使用加减按钮调整数值（支持步长调整）
     * 显示单位和正常范围提示

6. **建议内容实时同步到编辑器**
   - **选中建议时的同步机制**：
     * 医生点击任意建议项（文本、多选、单选、数值）时，系统立即触发编辑器内容更新
     * 系统调用 `updateEditorWithAllSelections()` 函数，扫描**所有模板**的已选中建议项
     * 根据建议类型生成相应的文本格式：
       - 文本建议：直接显示建议内容
       - 分组建议：显示"分组标题：建议内容"格式
       - 单选建议：显示"选项标题：选中内容"格式
       - 数值参数：显示"参数名称：数值+单位"格式
   
   - **跨模板状态管理**：
     * 系统维护全局选择状态存储（`globalSelections`），为每个模板独立保存选择状态
     * 模板切换时自动保存当前模板的选择状态，恢复目标模板的历史选择状态
     * 支持在不同模板间自由切换，不会丢失任何已做的选择
     * 每个模板的默认选择状态在页面加载时统一初始化
   
   - **编辑器内容结构化生成**：
     * 保持固定的问候语："尊敬的张先生："
     * 添加引导语："根据您的健康问卷，我为您提供以下健康建议："
     * **按模板分组显示建议**：每个有选中建议的模板单独显示一个分组
     * 每个模板分组包含：模板名称（加粗）+ 该模板下的所有选中建议列表
     * 保持固定的结束语："请继续保持良好的自我管理，如有任何不适，请及时联系我。"
   
   - **实时预览效果**：
     * 任何模板的建议选择状态变化时，编辑器内容立即更新，显示所有模板的选中建议
     * 数值参数调整时，编辑器中对应的数值实时变化
     * 单选建议切换时，编辑器中自动替换为新选中的内容
     * 模板切换时，编辑器内容实时更新，反映当前所有模板的选择状态

   - **内容格式化规则**：
     * 建议项按模板分组，每个模板内部按选择顺序排列
     * 模板分组标题使用模板名称，如"糖尿病饮食指导："
     * 相同模板内的建议会自动归类在同一个列表中
     * 数值参数会自动格式化为"参数名：数值单位"的形式
     * 支持HTML格式，包括加粗、列表等基础格式

7. **第三步：编辑健康指导内容**
   - 系统提供富文本编辑器，预填充基础问候语和结束语
   - 编辑器工具栏包含：加粗、斜体、下划线、项目符号、编号列表、清除格式等功能
   - 医生可以：
     * 编辑问候语和个性化称呼
     * 添加基于问卷回答的个性化建议
     * 调整建议的表述和顺序
     * 添加复诊安排和注意事项
     * 插入基于体检报告的具体指导

8. **辅助功能使用**
   - **查看问卷详情**：点击顶部问卷图标，侧边抽屉显示完整问卷内容
   - **查看体检报告**：点击顶部报告图标，侧边抽屉显示体检报告图片和数据
   - **实时预览**：编辑过程中可随时预览最终效果

9. **预览健康指导**
   - 医生点击"预览"按钮，系统弹出预览模态框
   - 预览内容以患者视角展示，包含完整的格式和样式
   - 医生可以检查内容的完整性和准确性
   - 如需修改，关闭预览继续编辑

10. **发送健康指导**
   - 医生确认内容无误后，点击"发送"按钮
   - 系统显示发送确认对话框，确认发送对象和内容摘要
   - 医生确认后，系统执行发送操作：
     * 保存健康指导内容到数据库
     * 更新问卷消息状态为"已回复"
     * 向患者发送健康指导通知
     * 记录发送时间和医生信息

11. **发送成功反馈**
    - 系统显示发送成功提示："健康指导已成功发送"
    - 自动跳转回消息列表页面或问卷详情页面
    - 在消息列表中，该条消息状态更新为"已回复"（绿色标识）

## 备选事件流

### 3a. 模板加载失败
3a1. 如果模板数据加载失败，系统显示错误提示："模板加载失败，请重试"
3a2. 提供"重新加载"按钮，医生可手动重试
3a3. 如果持续失败，提供"使用默认模板"选项
3a4. 记录错误日志，便于后续排查

### 3b. 模板状态同步异常
3b1. 如果模板切换时状态保存失败，系统显示"状态保存异常"警告
3b2. 自动尝试重新保存当前模板的选择状态
3b3. 如果状态恢复失败，使用该模板的默认选择状态
3b4. 提供"重置所有模板状态"选项，清空所有模板的选择记录

### 4a. 建议配置异常
4a1. 如果建议项配置数据异常，系统显示可用的部分建议
4a2. 对于缺失的建议项，显示"配置缺失"占位符
4a3. 医生可以跳过建议选择，直接进入编辑阶段
4a4. 系统记录配置异常情况，通知管理员修复

### 5a. 数值参数输入异常
5a1. 如果输入的数值超出合理范围，系统显示警告提示
5a2. 自动将数值调整到最接近的合理值
5a3. 如果输入非数值内容，系统恢复到默认值
5a4. 提供输入格式说明和建议范围提示

### 6a. 建议同步异常
6a1. 如果建议选择状态与编辑器内容不同步，系统自动重新同步
6a2. 如果编辑器更新失败，显示"内容同步异常"提示
6a3. 提供"手动刷新"按钮，允许用户重新生成编辑器内容
6a4. 记录同步异常日志，便于排查问题

### 6b. 跨模板状态异常
6b1. 如果全局状态存储损坏，系统自动重新初始化所有模板的默认状态
6b2. 如果某个模板的状态数据不完整，使用该模板的默认配置补全
6b3. 提供"重置所有选择"功能，允许用户清空所有模板的选择状态
6b4. 状态异常时优先保证当前模板的功能可用性

### 6c. 编辑器内容冲突
6c1. 如果用户手动编辑了编辑器内容，再选择建议时提示"是否覆盖当前内容"
6c2. 提供"合并内容"和"替换内容"两个选项
6c3. 合并模式下，新建议追加到现有内容后
6c4. 替换模式下，完全重新生成编辑器内容

### 7a. 编辑器功能异常
6a1. 如果富文本编辑器加载失败，降级为纯文本编辑模式
6a2. 如果格式化功能异常，保持基本的文本编辑功能
6a3. 定期自动保存编辑内容，防止意外丢失
6a4. 提供"恢复上次编辑"功能

### 8a. 辅助功能访问异常
7a1. 如果问卷数据加载失败，显示"问卷数据暂时无法访问"
7a2. 如果体检报告图片加载失败，显示占位图和重试选项
7a3. 提供"稍后查看"选项，不影响指导编辑流程
7a4. 记录访问异常，便于数据修复

### 10a. 发送操作异常

#### 10a1. 网络连接异常
- 系统检测到网络异常时，显示"网络连接不稳定"提示
- 自动保存当前编辑内容到本地缓存
- 提供"重新发送"按钮，支持离线编辑在线发送
- 网络恢复后自动提示用户重新发送

#### 10a2. 服务器响应异常
- 如果服务器返回错误，显示具体错误信息
- 区分不同错误类型：权限不足、数据验证失败、服务器内部错误
- 提供相应的解决建议和重试选项
- 严重错误时提供"保存草稿"功能

#### 10a3. 内容验证失败
- 如果指导内容不符合规范（如过短、包含敏感词），显示验证错误
- 高亮显示问题内容的位置
- 提供修改建议和规范说明
- 支持部分内容发送，标记需要补充的部分

### 11a. 发送后状态同步异常
11a1. 如果消息状态更新失败，显示"发送成功，状态同步中"
11a2. 后台继续尝试状态同步，成功后更新界面
11a3. 如果患者通知发送失败，记录失败原因并安排重发
11a4. 提供手动同步状态的选项

## 补充约束

### 功能性约束

#### 模板选择约束
- 系统必须提供至少3种基础健康指导模板：糖尿病、高血压、一般健康
- 模板选择支持横向滚动浏览，每个模板显示名称和简要描述
- 被选中的模板必须有明显的视觉标识（蓝色背景、边框高亮）
- **支持多模板组合使用**：模板切换时保持各模板的独立选择状态，不清空已选建议
- 每个模板的选择状态必须独立存储和恢复，确保状态一致性
- 支持模板的动态加载和缓存，提升用户体验

#### 建议配置约束
- 文本建议支持多选，每个建议项必须有清晰的描述文字
- 分组建议按逻辑分类（如饮食、运动、用药），每组至少包含2个选项
- 单选建议组内选项互斥，必须有默认选中项
- 数值参数必须设置合理的最小值、最大值和步长
- 所有建议项必须支持选中状态的持久化保存

#### 建议同步约束
- 建议项状态变化时，必须在200毫秒内同步到编辑器
- 编辑器内容更新必须保持结构化格式：问候语+按模板分组的建议列表+结束语
- **跨模板同步**：编辑器必须实时显示所有模板的选中建议，按模板分组展示
- 建议项在编辑器中的显示顺序必须与选择顺序一致
- 数值参数变化时，编辑器中对应数值必须实时更新
- 单选建议切换时，编辑器中必须自动替换旧内容
- 模板切换时，必须保存当前模板状态并恢复目标模板状态
- 建议内容与编辑器内容必须保持一致性，不允许出现同步延迟

#### 编辑器功能约束
- 富文本编辑器必须支持基本格式：加粗、斜体、下划线、列表
- 编辑内容最小长度50字符，最大长度2000字符
- 必须包含问候语和结束语，确保指导内容的完整性
- 支持实时字数统计和格式预览
- 编辑过程中每30秒自动保存草稿，防止内容丢失

#### 预览和发送约束
- 预览功能必须完整展示最终发送给患者的内容格式
- 发送前必须进行内容验证：长度检查、敏感词过滤、格式规范
- 发送操作必须有二次确认，防止误发
- 发送成功后必须更新相关状态：问卷状态、消息状态、指导记录
- 支持发送失败后的重试机制，最多重试3次

### 非功能性约束

#### 性能约束
- 页面初始加载时间不超过2秒
- 模板切换响应时间不超过500毫秒
- 建议项选择操作响应时间不超过200毫秒
- 编辑器输入响应时间不超过100毫秒
- 预览功能加载时间不超过1秒
- 发送操作完成时间不超过5秒

#### 用户体验约束
- 界面采用渐进式加载，优先显示核心功能
- 所有交互操作必须有即时的视觉反馈
- 支持手势操作：滑动切换模板、长按复制文本
- 在网络较差的情况下，优雅降级显示基本功能
- 页面切换动画流畅，过渡时间不超过300毫秒
- 支持横屏和竖屏模式的自适应布局

#### 兼容性约束
- 支持iOS 12.0+和Android 8.0+系统
- 兼容微信小程序基础库2.10.0+
- 支持主流移动设备的屏幕分辨率（375px-414px宽度）
- 在低端设备上保持基本功能可用性
- 支持深色模式和浅色模式自动适配

### 业务规则约束

#### 权限和安全约束
- 只有具备健康指导权限的医生可以发送指导
- 医生只能为分配给自己的患者提供健康指导
- 健康指导内容必须经过敏感词过滤和医疗规范检查
- 所有指导内容必须记录医生身份和发送时间
- 患者隐私信息在指导中必须得到适当保护

#### 数据管理约束
- 健康指导内容必须完整保存，支持历史查询
- 指导发送状态必须实时同步，确保数据一致性
- 草稿内容保留7天，超期自动清理
- 发送失败的指导内容必须保留，支持重新发送
- 所有操作行为必须记录审计日志

#### 医疗规范约束
- 健康指导内容必须基于患者的实际问卷回答和体检数据
- 不允许发送与患者病情不符的通用指导内容
- 药物相关建议必须谨慎，避免具体用药指导
- 必须包含"如有不适请及时就医"等免责提醒
- 指导内容必须符合医疗伦理和法规要求

#### 质量控制约束
- 每个患者在24小时内只能接收一次健康指导
- 指导内容重复度不能超过80%，确保个性化
- 系统必须记录指导效果反馈，用于质量改进
- 异常指导内容（过短、过长、格式错误）必须标记和审查
- 支持指导内容的版本管理和修订历史

## 待解决问题

1. **模板个性化程度**：
   - 当前模板是否足够灵活，能否满足不同患者的个性化需求？
   - 是否需要支持医生自定义模板或修改现有模板？

2. **建议项的智能推荐**：
   - 是否可以基于患者的问卷回答和体检数据，智能推荐最相关的建议项？
   - 如何平衡自动推荐和医生专业判断的关系？

3. **多模板组合优化**：
   - 当前支持多模板组合使用，是否需要检测模板间的建议冲突？
   - 如何优化多模板建议的显示顺序和分组逻辑？
   - 是否需要提供模板建议的去重功能？

4. **状态持久化策略**：
   - 跨模板状态管理的数据量较大，是否需要优化存储策略？
   - 如何处理长时间编辑过程中的状态数据备份和恢复？
   - 是否需要支持跨会话的状态保存？

5. **多媒体内容支持**：
   - 是否需要支持在健康指导中插入图片、视频或音频内容？
   - 如何处理多媒体内容的存储和传输问题？

6. **协作编辑功能**：
   - 是否需要支持多个医生协作编辑同一份健康指导？
   - 如何处理编辑冲突和版本控制问题？

7. **指导效果追踪**：
   - 如何设计患者对健康指导的反馈机制？
   - 是否需要建立指导效果的量化评估体系？

8. **离线编辑支持**：
   - 在网络不稳定的情况下，如何保证编辑体验的连续性？
   - 离线编辑的内容如何与在线数据同步？

## 相关图

### 界面流程图
```
问卷详情页面(doctor-questionnaire-detail.html)
    ↓ [点击"提供健康指导"]
健康指导编辑器(doctor-guidance-editor.html)
    ↓ [第一步：选择模板]
模板选择区域
    ↓ [第二步：配置建议]
建议选择区域 → [文本建议] → [分组建议] → [单选建议] → [数值参数]
    ↓ [第三步：编辑内容]
富文本编辑器 ← [辅助功能：查看问卷/报告]
    ↓ [预览检查]
预览模态框
    ↓ [确认发送]
发送确认对话框
    ↓ [发送成功]
消息列表页面(doctor-messages.html) [状态更新为已回复]
```

### 数据流图
```
患者问卷数据 → 健康指导编辑器 ← 指导模板库
                    ↓
              建议配置引擎
                    ↓
              富文本编辑器
                    ↓
              内容验证模块
                    ↓
              发送服务 → 患者通知系统
                    ↓
              数据存储 → 状态同步服务
```

### 模板配置结构图
```
健康指导模板
├── 基本信息（名称、描述、适用疾病）
├── 文本建议列表
├── 分组建议配置
│   ├── 饮食控制建议组
│   ├── 运动指导建议组
│   └── 监测频率建议组
├── 单选建议配置
│   ├── 复诊频率选项
│   └── 监测频率选项
└── 数值参数配置
    ├── 热量摄入参数
    ├── 营养比例参数
    └── 运动强度参数
```

## 技术实现要点

### 前端实现（基于实际代码）

#### 页面结构和样式
- **响应式布局**：使用Tailwind CSS框架，支持不同屏幕尺寸适配
- **卡片式设计**：患者信息、模板选择、建议配置、编辑器分别采用卡片布局
- **渐进式加载**：使用CSS动画（fade-in）实现页面元素的渐进显示
- **交互反馈**：按钮悬停效果、点击波纹效果、状态切换动画

#### 核心JavaScript功能模块

##### 模板管理模块
```javascript
// 模板选择功能
function selectTemplate(templateId) {
    // 更新模板选中状态
    // 加载对应的建议配置
    // 清空之前的选择状态
}

// 模板数据结构
const templates = {
    'diabetes-diet': {
        name: '糖尿病饮食指导',
        suggestions: {
            text: [...],      // 文本建议
            multiple: {...},  // 多选建议组
            single: {...},    // 单选建议组
            numeric: {...}    // 数值参数
        }
    }
}
```

##### 建议配置模块
```javascript
// 动态生成建议选择界面
function renderSuggestions(templateId) {
    // 根据模板配置生成不同类型的建议项
    // 文本建议：复选框 + 文本
    // 分组建议：分组标题 + 多个复选框
    // 单选建议：单选按钮组
    // 数值参数：输入框 + 单位 + 调节按钮
}

// 建议项交互处理函数
function toggleTextSuggestion(element, suggestionId) {
    // 切换文本建议的选中状态
    // 立即调用updateEditorWithSuggestions()同步到编辑器
}

function toggleMultipleSuggestion(element, groupKey, optionId) {
    // 切换多选建议的选中状态
    // 支持同组多个选项同时选中
}

function toggleSingleSuggestion(element, groupKey, optionId) {
    // 切换单选建议，先清除同组其他选项
    // 再选中当前选项
}

function toggleNumericSuggestion(element, numericKey) {
    // 切换数值参数的启用状态
    // 初始化默认数值
}

// 核心同步函数
function updateEditorWithSuggestions() {
    // 扫描所有已选中的建议项
    // 按类型生成结构化内容
    // 实时更新编辑器HTML内容
    // 保持固定的问候语和结束语格式
}
```

##### 富文本编辑器模块
```javascript
// 格式化功能
function formatText(command) {
    document.execCommand(command, false, null);
}

// 列表功能
function formatList(type) {
    const command = type === 'bullet' ? 'insertUnorderedList' : 'insertOrderedList';
    document.execCommand(command, false, null);
}

// 内容同步
function syncEditorContent() {
    // 将选择的建议项同步到编辑器
    // 保持内容的结构化和格式化
}
```

##### 辅助功能模块
```javascript
// 侧边抽屉控制
function showQuestionnaireDrawer() {
    // 显示问卷详情抽屉
    // 加载患者问卷数据
}

function showReportDrawer() {
    // 显示体检报告抽屉
    // 加载体检报告图片
}

// 预览功能
function previewGuidance() {
    // 生成预览内容
    // 显示预览模态框
}
```

##### 发送处理模块
```javascript
// 发送健康指导
function sendGuidance() {
    // 内容验证
    // 发送确认
    // 调用发送API
    // 处理发送结果
}

// 内容验证
function validateContent(content) {
    // 长度检查
    // 格式验证
    // 敏感词过滤
}
```

### 后端接口设计

#### 核心API接口

##### 模板管理接口
```javascript
// 获取指导模板列表
GET /api/doctor/guidance/templates
Response: {
    templates: [
        {
            id: "diabetes-diet",
            name: "糖尿病饮食指导",
            description: "针对糖尿病患者的饮食管理指导",
            category: "diabetes",
            suggestions: {...}
        }
    ]
}

// 获取特定模板详情
GET /api/doctor/guidance/templates/{templateId}
Response: {
    template: {
        id: "diabetes-diet",
        suggestions: {
            text: [...],
            multiple: {...},
            single: {...},
            numeric: {...}
        }
    }
}
```

##### 健康指导发送接口
```javascript
// 发送健康指导
POST /api/doctor/guidance/send
Request: {
    patientId: "string",
    questionnaireId: "string", 
    templateId: "string",
    selectedSuggestions: {
        text: ["suggestion1", "suggestion2"],
        multiple: {...},
        single: {...},
        numeric: {...}
    },
    customContent: "string", // 自定义编辑内容
    doctorId: "string"
}
Response: {
    success: true,
    guidanceId: "string",
    sendTime: "datetime",
    message: "健康指导发送成功"
}
```

##### 辅助数据接口
```javascript
// 获取患者问卷详情
GET /api/doctor/questionnaires/{questionnaireId}
Response: {
    questionnaire: {
        patientInfo: {...},
        questions: [...],
        submitTime: "datetime"
    }
}

// 获取患者体检报告
GET /api/doctor/medical-reports/{patientId}
Response: {
    reports: [
        {
            reportId: "string",
            reportDate: "date",
            hospital: "string",
            images: [...]
        }
    ]
}
```

### 数据结构设计

#### 建议同步机制实现

##### 核心同步函数详解
```javascript
// 全局状态管理结构
const globalSelections = {
    'diabetes-diet': { text: {}, multiple: {}, single: {}, numeric: {} },
    'diabetes-exercise': { text: {}, multiple: {}, single: {}, numeric: {} },
    'hypertension': { text: {}, multiple: {}, single: {}, numeric: {} },
    'general-health': { text: {}, multiple: {}, single: {}, numeric: {} }
};

// 跨模板状态同步函数
function updateEditorWithAllSelections() {
    const allSelectedSuggestions = [];

    // 遍历所有模板，收集选中的建议
    Object.keys(globalSelections).forEach(templateId => {
        const template = templates[templateId];
        const selections = globalSelections[templateId];

        if (!template || !selections) return;

        // 收集文本建议
        template.suggestions.text.forEach(suggestion => {
            if (selections.text[suggestion.id]) {
                allSelectedSuggestions.push({
                    templateName: template.name,
                    content: suggestion.content
                });
            }
        });

        // 收集多选建议
        Object.keys(template.suggestions.multiple).forEach(groupKey => {
            const group = template.suggestions.multiple[groupKey];
            const groupSelections = selections.multiple[groupKey] || {};

            group.options.forEach(option => {
                if (groupSelections[option.id]) {
                    allSelectedSuggestions.push({
                        templateName: template.name,
                        title: group.title.replace('（可多选）', ''),
                        content: option.content
                    });
                }
            });
        });

        // 收集单选建议
        Object.keys(template.suggestions.single).forEach(groupKey => {
            const group = template.suggestions.single[groupKey];
            const selectedOptionId = selections.single[groupKey];

            if (selectedOptionId) {
                const selectedOption = group.options.find(opt => opt.id === selectedOptionId);
                if (selectedOption) {
                    allSelectedSuggestions.push({
                        templateName: template.name,
                        title: group.title.replace('（单选）', ''),
                        content: selectedOption.content || ''
                    });
                }
            }
        });

        // 收集数值建议
        Object.keys(template.suggestions.numeric || {}).forEach(numericKey => {
            const numeric = template.suggestions.numeric[numericKey];
            const numericSelection = selections.numeric[numericKey];

            if (numericSelection && numericSelection.selected) {
                allSelectedSuggestions.push({
                    templateName: template.name,
                    title: numeric.title,
                    content: `${numericSelection.value}${numeric.unit}`
                });
            }
        });
    });

    // 生成按模板分组的编辑器内容
    let editorContent = '<p>尊敬的张先生：</p>\n\n';
    editorContent += '<p>根据您的健康问卷，我为您提供以下健康建议：</p>\n\n';

    if (allSelectedSuggestions.length > 0) {
        // 按模板分组显示建议
        const groupedSuggestions = {};
        allSelectedSuggestions.forEach(suggestion => {
            if (!groupedSuggestions[suggestion.templateName]) {
                groupedSuggestions[suggestion.templateName] = [];
            }
            groupedSuggestions[suggestion.templateName].push(suggestion);
        });

        Object.keys(groupedSuggestions).forEach(templateName => {
            editorContent += `<p><strong>${templateName}：</strong></p>\n<ul>\n`;

            groupedSuggestions[templateName].forEach(suggestion => {
                if (suggestion.title && suggestion.content && suggestion.title !== suggestion.content) {
                    editorContent += `    <li><strong>${suggestion.title}：</strong>${suggestion.content}</li>\n`;
                } else {
                    editorContent += `    <li>${suggestion.content}</li>\n`;
                }
            });

            editorContent += '</ul>\n\n';
        });
    }

    editorContent += '<p>请继续保持良好的自我管理，如有任何不适，请及时联系我。</p>';

    // 更新编辑器DOM
    document.getElementById('editor').innerHTML = editorContent;
}

// 模板切换时的状态管理
function selectTemplate(templateId) {
    // 保存当前模板的选择状态
    saveCurrentTemplateSelections();
    
    // 更新当前模板
    currentTemplate = templateId;
    
    // 渲染新模板的建议选择区域
    renderSuggestions(templateId);
    
    // 恢复新模板的选择状态
    setTimeout(() => {
        restoreTemplateSelections(templateId);
        updateEditorWithAllSelections();
    }, 0);
}
```

##### 事件绑定和触发机制
```javascript
// 每个建议项点击时都会触发对应的处理函数
// 处理函数最后都会调用updateEditorWithAllSelections()

// 文本建议点击处理
function toggleTextSuggestion(element, suggestionId) {
    const checkbox = element.querySelector('.suggestion-checkbox');
    checkbox.classList.toggle('checked');
    
    // 更新全局选择状态
    globalSelections[currentTemplate].text[suggestionId] = checkbox.classList.contains('checked');
    
    updateEditorWithAllSelections(); // 立即同步所有模板的选择
}

// 数值参数变化处理
function updateNumericValue(key, value) {
    // 验证和更新数值
    const template = templates[currentTemplate];
    const numeric = template.suggestions.numeric[key];
    value = Math.max(numeric.min, Math.min(numeric.max, parseInt(value) || numeric.defaultValue));
    
    // 更新全局状态
    if (!globalSelections[currentTemplate].numeric[key]) {
        globalSelections[currentTemplate].numeric[key] = { selected: false, value: value };
    } else {
        globalSelections[currentTemplate].numeric[key].value = value;
    }
    
    updateEditorWithAllSelections(); // 立即同步所有模板的选择
}

// 模板状态保存和恢复
function saveCurrentTemplateSelections() {
    // 保存当前模板的UI状态到globalSelections
}

function restoreTemplateSelections(templateId) {
    // 从globalSelections恢复模板的UI状态
}
```

#### 健康指导记录数据结构
```json
{
    "guidanceId": "string",
    "patientId": "string", 
    "doctorId": "string",
    "questionnaireId": "string",
    "templateId": "string",
    "guidanceContent": {
        "templateName": "string",
        "selectedSuggestions": {
            "text": ["string"],
            "multiple": {
                "groupId": ["optionId"]
            },
            "single": {
                "groupId": "optionId"
            },
            "numeric": {
                "parameterId": {
                    "value": "number",
                    "unit": "string"
                }
            }
        },
        "customContent": "string",
        "finalContent": "string" // 最终发送的完整内容
    },
    "sendTime": "datetime",
    "status": "sent|delivered|read",
    "metadata": {
        "contentLength": "number",
        "sendMethod": "template|custom",
        "deviceInfo": "string"
    }
}
```

#### 模板配置数据结构
```json
{
    "templateId": "string",
    "templateName": "string",
    "category": "string",
    "description": "string",
    "isActive": "boolean",
    "suggestions": {
        "text": [
            {
                "id": "string",
                "content": "string",
                "defaultSelected": "boolean",
                "category": "string"
            }
        ],
        "multiple": {
            "groupId": {
                "title": "string",
                "options": [
                    {
                        "id": "string",
                        "content": "string",
                        "defaultSelected": "boolean"
                    }
                ]
            }
        },
        "single": {
            "groupId": {
                "title": "string",
                "defaultSelected": "string",
                "options": [
                    {
                        "id": "string",
                        "content": "string"
                    }
                ]
            }
        },
        "numeric": {
            "parameterId": {
                "title": "string",
                "unit": "string",
                "defaultValue": "number",
                "defaultSelected": "boolean",
                "min": "number",
                "max": "number",
                "step": "number"
            }
        }
    },
    "createdTime": "datetime",
    "updatedTime": "datetime",
    "createdBy": "string"
}
```

### 页面路由和导航

#### 页面跳转逻辑
```javascript
// 从问卷详情进入指导编辑器
function provideGuidance() {
    const patientId = getUrlParameter('patient');
    window.location.href = `doctor-guidance-editor.html?patientId=${patientId}`;
}

// 发送成功后返回消息列表
function returnToMessages() {
    window.location.href = 'doctor-messages.html';
}

// 返回导航处理
function goBack() {
    if (window.history.length > 1) {
        window.history.back();
    } else {
        window.location.href = 'doctor-messages.html';
    }
}
```

#### URL参数管理
- `patientId`：患者标识，用于加载患者相关数据
- `questionnaireId`：问卷标识，用于关联具体的问卷记录
- `templateId`：可选参数，用于预选择特定模板
- `draft`：可选参数，用于加载之前保存的草稿

### 错误处理和用户反馈

#### 错误处理策略
```javascript
// 统一错误处理
function handleError(error, context) {
    console.error(`Error in ${context}:`, error);
    
    switch(error.type) {
        case 'network':
            showToast('网络连接异常，请检查网络设置', 'error');
            break;
        case 'validation':
            showToast(error.message, 'warning');
            break;
        case 'permission':
            showToast('权限不足，请联系管理员', 'error');
            break;
        default:
            showToast('操作失败，请重试', 'error');
    }
}

// 用户反馈提示
function showToast(message, type = 'info') {
    // 创建并显示提示消息
    // 支持不同类型的样式：info, success, warning, error
}
```

#### 加载状态管理
```javascript
// 加载状态控制
function setLoadingState(element, isLoading) {
    if (isLoading) {
        element.disabled = true;
        element.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
    } else {
        element.disabled = false;
        element.innerHTML = element.dataset.originalText;
    }
}
```

这个用例文档详细描述了"发送健康指导"功能的完整流程，包括用户交互、系统响应、异常处理和技术实现细节，为开发团队提供了全面的功能规范和实现指导。