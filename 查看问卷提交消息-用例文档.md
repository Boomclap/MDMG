# 查看问卷提交消息 - 用例文档

## 用例基本信息

| 项目 | 内容 |
|------|------|
| **用例名称** | 查看问卷提交消息 |
| **简要描述** | 医生通过小程序查看患者提交的健康问卷通知消息，筛选待处理和已处理的消息，并可以进入详情页面查看具体问卷内容和提供健康指导 |
| **参与者** | 医生（主要参与者） |
| **涉众** | 医生、患者、健康指导系统 |
| **相关用例** | 提交健康问卷、查看患者问卷详情、提供健康指导、查看健康指导记录 |

## 前置条件

• 医生已完成小程序登录认证
• 系统中存在医生账户信息和权限配置
• 患者已提交健康问卷，系统已生成相应的通知消息
• 医生与患者之间已建立医患关系（分配关系）

## 后置条件

• 医生成功查看问卷提交消息列表，了解待处理和已处理的问卷情况
• 系统记录医生的消息查看行为和时间
• 医生可以基于消息内容进入后续的问卷详情查看或健康指导流程

## 基本事件流

1. **医生进入消息中心**
   - 医生在小程序主页通过底部导航或首页快捷入口进入消息中心
   - 系统显示顶部导航栏，标题为"问卷提交通知"，包含返回按钮和更多操作按钮

2. **系统加载并显示消息列表**
   - 系统从后台获取分配给当前医生的所有问卷提交消息
   - 消息列表按时间倒序排列，每条消息包含：
     * 患者头像（显示患者姓氏首字母，渐变色背景）
     * 患者姓名
     * 问卷类型描述（如"提交了糖尿病健康问卷"）
     * 提交时间（相对时间显示，如"2分钟前"、"昨天 16:30"）
     * 处理状态标识（待回复/已回复）

3. **消息状态标识和动画效果**
   - 待处理消息具有蓝色左边框脉动动画效果
   - 待处理消息的状态标签显示为蓝色"待回复"并带有轻微缩放动画
   - 已处理消息的状态标签显示为绿色"已回复"

4. **消息筛选功能**
   - 医生可以通过顶部筛选标签切换消息视图：
     * "全部"：显示所有消息，标签显示总消息数量
     * "待回复"：仅显示未处理的问卷消息，标签显示待处理数量
     * "已回复"：仅显示已提供健康指导的消息，标签显示已处理数量
   - 切换筛选时有平滑的过渡动画效果

5. **查看消息详情**
   - 医生点击具体消息项时，系统添加波纹点击效果
   - 根据消息状态进行不同的跳转：
     * 待处理消息：跳转到问卷详情页面（doctor-questionnaire-detail.html）
     * 已处理消息：跳转到回复查看页面（doctor-reply-viewer.html）

### 5.1 查看问卷详情（待处理消息）

1. **页面加载和导航**
   - 系统显示问卷详情页面，顶部导航显示"问卷详情"标题和返回按钮
   - 页面采用卡片式布局，包含患者信息、问卷内容、体检报告三个主要部分

2. **患者信息展示**
   - 显示患者头像（姓氏首字母，渐变色背景）
   - 展示患者基本信息：姓名、性别、年龄、疾病类型
   - 信息以卡片形式呈现，带有用户图标标识

3. **问卷内容查看**
   - 显示问卷元数据：问卷类型、提交时间
   - 逐条展示问卷问题和患者回答：
     * 问题以深色字体显示，编号清晰
     * 答案以蓝色背景框显示，带有左侧蓝色边框
     * 支持长文本答案的完整显示

4. **体检报告查看**
   - 如有体检报告：显示体检日期、医院信息
   - 以横向滚动的图片画廊形式展示多页报告
   - 每张图片显示页码标识，支持点击放大查看
   - 如无体检报告：显示空状态提示和"提醒上传体检报告"按钮

5. **操作功能**
   - 底部固定"提供健康指导"按钮，点击跳转到指导编辑器
   - 支持图片全屏查看模态框，包含关闭按钮
   - 提醒上传报告功能，显示成功提示反馈

### 5.2 查看回复详情（已处理消息）

1. **页面加载和状态显示**
   - 系统显示回复详情页面，顶部导航显示"查看回复详情"标题
   - 导航右侧显示绿色"已回复"状态标识
   - 页面采用渐入动画效果，提升用户体验

2. **患者信息确认**
   - 重新显示患者基本信息，确保医生查看正确的回复记录
   - 包含患者头像、姓名、基本信息和问卷类型

3. **回复信息展示**
   - 显示回复医生信息：姓名、科室、职称
   - 显示回复时间，采用相对时间格式
   - 信息以蓝色背景卡片形式突出显示

4. **回复内容查看**
   - 以只读模式展示完整的健康指导内容
   - 支持富文本格式：段落、列表、加粗文字等
   - 内容采用灰色背景框，便于阅读
   - 保持原有的格式和结构，包括：
     * 问候语和称呼
     * 分类建议（饮食、运动、监测等）
     * 复诊安排和注意事项

5. **导航功能**
   - 提供返回按钮，支持返回消息列表或上一页
   - 如果是直接访问，默认返回消息中心

## 备选事件流

### 2a. 无问卷消息时
2a1. 系统显示空状态页面，提示"暂无问卷提交消息"
2a2. 显示引导文案："患者提交问卷后会在此显示通知"
2a3. 可选择显示引导按钮，帮助医生了解如何让患者提交问卷

### 2b. 消息加载失败时
2b1. 系统显示网络错误提示："网络连接异常，请检查网络设置"
2b2. 提供"重新加载"按钮
2b3. 医生点击重新加载，系统重新获取消息列表
2b4. 如果多次加载失败，提示联系技术支持

### 4a. 消息列表交互异常
4a1. 如果筛选标签切换失败，保持当前视图不变
4a2. 如果消息项点击无响应，显示轻微震动反馈提示用户重试
4a3. 如果页面跳转失败，显示错误提示并保持在当前页面

### 5a. 问卷详情页面跳转异常
5a1. 如果目标页面不存在或加载失败，显示错误提示
5a2. 提供返回消息列表的选项
5a3. 记录错误日志供后续排查

### 5.1a. 问卷详情页面异常情况

#### 5.1a1. 患者数据加载失败
- 如果患者信息获取失败，显示默认头像和"数据加载中"提示
- 提供重新加载按钮，允许用户手动刷新
- 如果多次加载失败，显示联系技术支持的提示

#### 5.1a2. 问卷内容显示异常
- 如果问卷数据不完整，显示可用的部分内容
- 对于缺失的问题或答案，显示"数据缺失"占位符
- 记录异常情况，便于后续数据修复

#### 5.1a3. 体检报告加载异常
- 如果图片加载失败，显示图片占位符和重新加载选项
- 如果图片格式不支持，提示用户联系患者重新上传
- 网络较差时，提供低质量图片预览选项

#### 5.1a4. 操作按钮异常
- 如果"提供健康指导"按钮点击无响应，显示加载状态
- 如果跳转失败，保持在当前页面并显示错误提示
- 提供重试机制，允许用户再次尝试操作

### 5.2a. 回复详情页面异常情况

#### 5.2a1. 回复数据不存在
- 如果找不到对应的回复记录，显示"暂无回复内容"提示
- 提供返回消息列表的快捷按钮
- 记录数据不一致的情况，便于排查

#### 5.2a2. 回复内容格式异常
- 如果回复内容包含不支持的格式，进行安全过滤显示
- 对于损坏的富文本内容，降级为纯文本显示
- 保持内容的可读性，避免显示乱码

#### 5.2a3. 医生信息显示异常
- 如果医生信息缺失，显示"系统医生"作为默认值
- 如果时间格式异常，显示原始时间戳
- 确保页面基本功能不受影响

## 补充约束

### 功能性约束

#### 消息列表约束
- 消息列表支持下拉刷新功能，获取最新的问卷提交消息
- 待处理消息具有明显的视觉标识：蓝色左边框、脉动动画效果、蓝色状态标签
- 消息严格按提交时间倒序排列，确保最新消息优先显示
- 每个消息项必须包含：患者头像、姓名、问卷类型、提交时间、处理状态
- 筛选标签必须显示对应类别的消息数量，并支持实时更新
- 消息项点击时提供视觉反馈（波纹效果）

#### 问卷详情页面约束
- 问卷详情页面必须完整显示所有问题和答案，不允许截断
- 体检报告图片支持横向滚动查看，每张图片必须有页码标识
- 图片点击放大功能必须支持手势缩放和拖拽
- "提供健康指导"按钮必须固定在页面底部，始终可见
- 页面加载时必须有渐入动画效果，提升用户体验

#### 回复详情页面约束
- 回复内容必须保持原有格式，支持富文本显示
- 医生信息和回复时间必须准确显示，不允许缺失
- 回复内容采用只读模式，不允许编辑
- 页面必须明确标识"已回复"状态，避免用户混淆
- 支持长文本内容的完整显示，必要时提供滚动功能

### 非功能性约束

#### 性能约束
- 消息列表初始加载时间不超过3秒
- 页面切换和筛选操作响应时间不超过500毫秒
- 问卷详情页面加载时间不超过2秒
- 回复详情页面加载时间不超过1.5秒
- 体检报告图片加载时间不超过5秒（单张）
- 图片放大和缩放操作响应时间不超过300毫秒

#### 用户体验约束
- 界面滚动流畅，无明显卡顿现象
- 支持不同屏幕尺寸的响应式适配（4.7寸-6.7寸）
- 动画效果流畅自然，不影响用户操作体验
- 在网络较差的情况下，优雅降级显示基本信息
- 页面切换动画时长不超过300毫秒
- 所有交互操作必须有即时的视觉反馈

#### 兼容性约束
- 支持iOS 12.0+和Android 8.0+系统
- 兼容微信小程序基础库2.10.0+
- 支持主流移动设备的屏幕分辨率
- 在低端设备上保持基本功能可用性
- 支持深色模式和浅色模式自动适配

### 业务规则约束

#### 权限和安全约束
- 只显示分配给当前登录医生的患者问卷消息
- 消息按医患关系进行权限控制，确保数据安全
- 问卷详情和回复内容仅对授权医生可见
- 体检报告图片访问需要验证医生权限
- 所有敏感信息传输必须加密处理

#### 数据管理约束
- 消息状态更新需要实时同步，避免状态不一致
- 待处理消息数量在筛选标签上用红色徽章显示，超过99显示"99+"
- 消息保留期限为30天，超期消息自动归档但不删除
- 问卷数据和回复内容需要完整保存，不允许丢失
- 系统需要记录医生的消息查看行为，用于统计分析

#### 操作规则约束
- 医生查看问卷详情后，消息自动标记为已读
- 已回复的消息不允许重复回复，只能查看回复详情
- 问卷提交后24小时内必须有医生响应提醒
- 体检报告上传后需要医生确认查看
- 回复内容一旦发送不允许修改，只能追加补充说明

#### 审计和合规约束
- 所有医生操作行为需要记录审计日志
- 患者隐私信息显示需要符合医疗数据保护规范
- 问卷和回复内容需要支持导出备份
- 系统需要支持医疗质量监管部门的数据审查
- 异常操作和数据访问需要实时监控和告警

## 待解决问题

1. **实时消息推送**：
   - 是否需要实现WebSocket或Server-Sent Events来实时推送新的问卷提交消息？
   - 如何处理医生离线时的消息推送和同步？

2. **消息优先级和分类**：
   - 是否需要根据患者病情严重程度对消息进行优先级排序？
   - 如何根据问卷类型（糖尿病、高血压、心脏病等）进行颜色标识或图标区分？

3. **批量操作功能**：
   - 是否需要支持批量标记已读功能？
   - 是否需要支持批量导出问卷数据功能？

4. **搜索和过滤功能**：
   - 当消息数量较多时，是否需要提供按患者姓名搜索功能？
   - 是否需要按问卷类型、提交时间范围进行高级筛选？

5. **消息提醒机制**：
   - 待处理消息的提醒频率如何设定？
   - 是否需要在医生主页显示待处理消息的数量提醒？

6. **数据同步和缓存策略**：
   - 如何处理网络不稳定时的数据同步问题？
   - 离线缓存的数据量和更新策略如何确定？

## 相关图

### 界面流程图
```
医生主页(doctor-main.html)
    ↓ [点击消息入口]
消息中心(doctor-messages.html)
    ↓ [筛选标签: 全部/待回复/已回复]
问卷消息列表
    ↓ [点击待处理消息]          ↓ [点击已处理消息]
问卷详情页面                    回复查看页面
(doctor-questionnaire-detail.html)  (doctor-reply-viewer.html)
    ↓ [提供健康指导]
健康指导编辑器
(doctor-guidance-editor.html)
```

### 消息状态流转图
```
患者提交问卷 → 系统生成消息通知 → 医生查看消息列表 → 医生点击消息
                                    ↓
                              查看问卷详情 → 提供健康指导 → 消息状态更新为已处理
                                    ↓
                              后续可查看回复详情
```

### 数据流图
```
患者端小程序 → [提交问卷] → 后台API → [生成消息] → 消息数据库
                                                    ↓
医生端小程序 ← [消息列表] ← 后台API ← [查询消息] ← 消息数据库
```

## 技术实现要点

### 前端实现（基于实际代码）
- **页面结构**：使用HTML5 + CSS3 + JavaScript实现，采用响应式设计
- **样式框架**：集成Tailwind CSS和Font Awesome图标库
- **动画效果**：
  * CSS动画实现消息项的脉动效果（@keyframes pulse）
  * 点击波纹效果（addRipple函数）
  * 页面加载时的渐入动画（fade-in）
- **交互功能**：
  * 筛选标签切换（switchFilter函数）
  * 消息项点击跳转（openQuestionnaire函数）
  * 返回导航（goBack函数）

### 核心JavaScript函数
```javascript
// 筛选消息
function switchFilter(element, type) {
    // 更新标签状态，筛选消息显示
}

// 打开问卷详情
function openQuestionnaire(element, patientId) {
    // 根据消息状态跳转到不同页面
    // 待处理 → doctor-questionnaire-detail.html
    // 已处理 → doctor-reply-viewer.html
}

// 添加波纹效果
function addRipple(element, event) {
    // 创建点击波纹动画
}
```

### 后端接口设计
- `GET /api/doctor/messages/questionnaires` - 获取问卷消息列表
  * 查询参数：status (all/pending/completed), page, pageSize
  * 返回：消息列表数据和分页信息
- `PUT /api/doctor/messages/{messageId}/read` - 标记消息为已读
- `GET /api/doctor/messages/count` - 获取各状态消息数量统计

### 数据结构（基于实际实现）

#### 消息列表数据结构
```json
{
  "messageId": "string",
  "patientId": "string",
  "patientName": "string", 
  "patientAvatar": "string", // 患者头像URL或姓氏首字母
  "questionnaireType": "string", // 如"糖尿病健康问卷"
  "questionnaireContent": "string", // 问卷描述文本
  "submitTime": "datetime", // ISO格式时间
  "status": "pending|completed", // 处理状态
  "isRead": "boolean",
  "relativeTime": "string" // 相对时间显示，如"2分钟前"
}
```

#### 问卷详情数据结构
```json
{
  "questionnaireId": "string",
  "patientInfo": {
    "patientId": "string",
    "name": "string",
    "avatar": "string",
    "gender": "male|female",
    "age": "number",
    "diseases": ["string"] // 疾病列表
  },
  "questionnaire": {
    "type": "string", // 问卷类型
    "submitTime": "datetime",
    "questions": [
      {
        "questionId": "string",
        "questionText": "string",
        "answer": "string"
      }
    ]
  },
  "medicalReports": [
    {
      "reportId": "string",
      "reportDate": "date",
      "hospital": "string",
      "images": [
        {
          "imageId": "string",
          "imageUrl": "string",
          "pageNumber": "number"
        }
      ]
    }
  ]
}
```

#### 回复详情数据结构
```json
{
  "replyId": "string",
  "patientInfo": {
    "patientId": "string",
    "name": "string",
    "avatar": "string",
    "meta": "string" // 基本信息摘要
  },
  "replyInfo": {
    "doctorId": "string",
    "doctorName": "string",
    "department": "string",
    "title": "string", // 职称
    "replyTime": "datetime"
  },
  "replyContent": {
    "contentId": "string",
    "htmlContent": "string", // 富文本内容
    "plainContent": "string", // 纯文本备份
    "contentType": "html|markdown|plain"
  }
}
```

### 页面路由配置

#### 主要页面路由
- **消息列表页面**：`doctor-messages.html`
  * 查询参数：无
  * 功能：显示问卷提交消息列表，支持筛选

- **问卷详情页面**：`doctor-questionnaire-detail.html?patient={patientId}`
  * 查询参数：patient（患者ID）
  * 可选参数：noReport=true（演示无体检报告状态）
  * 功能：显示问卷详情、体检报告，提供健康指导入口

- **回复查看页面**：`doctor-reply-viewer.html?patient={patientId}`
  * 查询参数：patient（患者ID）
  * 功能：显示已发送的健康指导回复内容

- **健康指导编辑页面**：`doctor-guidance-editor.html?patientId={patientId}`
  * 查询参数：patientId（患者ID）
  * 功能：编辑和发送健康指导内容

#### 页面跳转逻辑
```javascript
// 消息列表 → 问卷详情（待处理消息）
window.location.href = `doctor-questionnaire-detail.html?patient=${patientId}`;

// 消息列表 → 回复查看（已处理消息）
window.location.href = `doctor-reply-viewer.html?patient=${patientId}`;

// 问卷详情 → 健康指导编辑
window.location.href = `doctor-guidance-editor.html?patientId=${patientId}`;

// 返回导航逻辑
function goBack() {
    if (window.history.length > 1) {
        window.history.back();
    } else {
        window.location.href = 'doctor-messages.html';
    }
}
```

#### URL参数说明
- `patient`：用于问卷详情和回复查看页面的患者标识
- `patientId`：用于健康指导编辑页面的患者标识
- `noReport`：可选参数，用于演示无体检报告的状态
- 所有页面都支持通过返回按钮或浏览器后退返回上一页