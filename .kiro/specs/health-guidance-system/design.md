# Design Document

## Overview

医患问卷指导系统是一个双端应用，包括医生端和患者端。医生端用于接收患者提交的问卷，查看问卷回答和体检报告，并提供健康指导；患者端用于提交问卷，上传体检报告，接收医生的健康指导。本设计文档主要关注医生端的问卷查看和健康指导功能，以及患者端的健康指导接收和查看功能。

## Architecture

系统采用前端渲染架构，使用HTML、CSS和JavaScript实现。数据通过消息传递机制在医生端和患者端之间同步。主要组件包括：

1. **医生端**
   - 消息中心：显示患者提交的问卷消息
   - 问卷详情页：显示患者问卷回答和体检报告
   - 健康指导编辑器：提供模板选择和编辑功能

2. **患者端**
   - 消息中心：显示医生发送的健康指导消息
   - 健康指导详情页：显示医生的健康指导和相关问卷

3. **数据同步机制**
   - 使用postMessage进行iframe间通信
   - 实现医生端和患者端的实时数据同步

## Components and Interfaces

### 1. 医生端消息中心

**功能**：
- 显示患者提交的问卷消息列表
- 区分待处理和已处理的消息
- 提供筛选功能

**界面元素**：
- 筛选标签：全部、待处理、已指导
- 消息列表：显示患者头像、姓名、问卷类型、提交时间和状态
- 消息项点击事件：跳转到问卷详情页

### 2. 问卷详情页

**功能**：
- 显示患者基本信息
- 显示问卷问题和患者回答
- 显示患者体检报告（如有）
- 提供提醒上传体检报告的功能
- 提供进入健康指导编辑器的入口

**界面元素**：
- 患者信息区：头像、姓名、年龄、性别等
- 问卷内容区：问题和回答的列表
- 体检报告区：体检报告图片缩略图或"无体检报告"提示
- 操作按钮：提醒上传体检报告、提供健康指导

### 3. 健康指导编辑器

**功能**：
- 提供健康指导模板选择
- 支持编辑健康指导内容
- 支持勾选健康指导建议
- 发送健康指导给患者

**界面元素**：
- 模板选择区：常用健康指导模板列表
- 编辑区：富文本编辑器
- 建议列表：可勾选的健康指导建议
- 操作按钮：预览、发送

### 4. 患者端消息中心

**功能**：
- 显示医生发送的健康指导消息
- 标记未读消息
- 提供消息点击跳转

**界面元素**：
- 消息列表：显示医生头像、姓名、消息类型、发送时间
- 未读标记：新消息的视觉提示
- 消息项点击事件：跳转到健康指导详情页

### 5. 健康指导详情页

**功能**：
- 显示医生的健康指导内容
- 显示相关联的问卷信息
- 提供查看相关问卷的功能
- 提供确认已了解的功能

**界面元素**：
- 医生信息区：头像、姓名、科室等
- 健康指导内容区：医生的指导内容
- 相关问卷区：问卷标题和摘要
- 操作按钮：查看相关问卷、确认已了解

## Data Models

### 1. 消息数据模型

```javascript
{
  id: String,           // 消息唯一标识
  type: String,         // 消息类型：'questionnaire', 'guidance'
  senderId: String,     // 发送者ID
  receiverId: String,   // 接收者ID
  content: Object,      // 消息内容
  status: String,       // 消息状态：'unread', 'read', 'processed'
  timestamp: Number     // 发送时间戳
}
```

### 2. 问卷数据模型

```javascript
{
  id: String,           // 问卷唯一标识
  patientId: String,    // 患者ID
  title: String,        // 问卷标题
  type: String,         // 问卷类型：'diabetes', 'hypertension', etc.
  questions: [          // 问题列表
    {
      id: String,       // 问题ID
      text: String,     // 问题文本
      type: String,     // 问题类型：'single', 'multiple', 'text'
      options: Array,   // 选项列表（如有）
      answer: Any       // 患者回答
    }
  ],
  submittedAt: Number,  // 提交时间戳
  status: String        // 问卷状态：'pending', 'guided'
}
```

### 3. 体检报告数据模型

```javascript
{
  id: String,           // 报告唯一标识
  patientId: String,    // 患者ID
  reportDate: String,   // 体检日期
  imageUrls: [String],  // 体检报告图片URL列表
  uploadedAt: Number,   // 上传时间戳
  hospital: String,     // 体检医院
  description: String   // 报告简要描述（可选）
}
```

### 4. 健康指导数据模型

```javascript
{
  id: String,           // 指导唯一标识
  doctorId: String,     // 医生ID
  patientId: String,    // 患者ID
  questionnaireId: String, // 关联问卷ID
  content: String,      // 指导内容（富文本）
  suggestions: [        // 健康建议列表
    {
      id: String,       // 建议ID
      text: String      // 建议内容
    }
  ],
  createdAt: Number,    // 创建时间戳
  status: String        // 指导状态：'sent', 'read', 'understood'
}
```

## Error Handling

1. **网络错误**
   - 实现离线数据缓存
   - 提供重试机制
   - 显示友好的错误提示

2. **数据同步错误**
   - 实现数据一致性检查
   - 提供手动同步功能
   - 记录同步失败的操作

3. **用户输入错误**
   - 实现表单验证
   - 提供即时反馈
   - 防止重复提交

4. **系统错误**
   - 实现错误日志记录
   - 提供错误恢复机制
   - 显示用户友好的错误页面

## Testing Strategy

1. **单元测试**
   - 测试各组件的独立功能
   - 测试数据模型的有效性
   - 测试错误处理机制

2. **集成测试**
   - 测试组件间的交互
   - 测试数据流转
   - 测试消息传递机制

3. **端到端测试**
   - 测试完整用户流程
   - 测试医生端和患者端的交互
   - 测试实际场景下的系统表现

4. **用户体验测试**
   - 测试界面的易用性
   - 测试响应速度
   - 收集用户反馈

## UI Design

### 医生端问卷详情页（手机端）

```
+-------------------------------------------------------+
|                     患者基本信息                        |
| [头像] 姓名：张三  性别：男  年龄：45                    |
+-------------------------------------------------------+
|                     问卷内容                           |
| 问卷类型：糖尿病健康问卷  提交时间：2023-07-15 14:30     |
|                                                       |
| Q1: 您是否有糖尿病家族史？                              |
| A: 是，父亲有糖尿病                                    |
|                                                       |
| Q2: 您的空腹血糖值是多少？                              |
| A: 7.2 mmol/L                                        |
|                                                       |
| ...更多问题和回答...                                   |
+-------------------------------------------------------+
|                     体检报告                           |
| [无体检报告] [提醒上传体检报告]                          |
| 或                                                    |
| 体检日期：2023-06-20  医院：XX医院                     |
| [体检报告图片缩略图]                                   |
| [点击查看大图]                                         |
+-------------------------------------------------------+
|                     操作区域                           |
| [返回]                          [提供健康指导]         |
+-------------------------------------------------------+
```

### 健康指导编辑器

```
+-------------------------------------------------------+
|                     患者信息                           |
| [头像] 张三  问卷：糖尿病健康问卷                        |
+-------------------------------------------------------+
|                     模板选择                           |
| [糖尿病饮食指导] [糖尿病运动指导] [高血压用药指导]        |
+-------------------------------------------------------+
|                     编辑区域                           |
| [富文本编辑器]                                         |
| 尊敬的张三先生：                                       |
|                                                       |
| 根据您的问卷回答和体检报告，我为您提供以下健康建议：       |
|                                                       |
| 1. 控制饮食，减少碳水化合物摄入                         |
| 2. 每天进行30分钟中等强度的有氧运动                     |
| 3. 定期监测血糖                                        |
| ...                                                   |
+-------------------------------------------------------+
|                     建议列表                           |
| [✓] 控制饮食，减少碳水化合物摄入                        |
| [✓] 每天进行30分钟中等强度的有氧运动                    |
| [✓] 定期监测血糖                                       |
| [ ] 避免吸烟和饮酒                                     |
| [ ] 保持良好的睡眠习惯                                 |
| [ ] 定期复诊                                          |
+-------------------------------------------------------+
|                     操作区域                           |
| [预览]                             [发送]             |
+-------------------------------------------------------+
```

### 患者端健康指导详情页

```
+-------------------------------------------------------+
|                     医生信息                           |
| [头像] 李医生  内分泌科主任医师                         |
| 发送时间：2023-07-16 10:30                            |
+-------------------------------------------------------+
|                     健康指导内容                        |
| 尊敬的张三先生：                                       |
|                                                       |
| 根据您的问卷回答和体检报告，我为您提供以下健康建议：       |
|                                                       |
| 1. 控制饮食，减少碳水化合物摄入                         |
| 2. 每天进行30分钟中等强度的有氧运动                     |
| 3. 定期监测血糖                                        |
| ...                                                   |
+-------------------------------------------------------+
|                     相关问卷                           |
| 问卷：糖尿病健康问卷  提交时间：2023-07-15 14:30        |
| [查看相关问卷]                                         |
+-------------------------------------------------------+
|                     操作区域                           |
| [返回]                          [确认已了解]           |
+-------------------------------------------------------+
```

## Mobile-First Design Considerations

1. **触摸友好界面**
   - 所有可点击元素尺寸足够大（至少44x44像素）
   - 合理的元素间距，避免误触
   - 使用手势操作增强用户体验

2. **响应式布局**
   - 适应不同屏幕尺寸
   - 关键内容优先显示
   - 垂直滚动优于水平滚动

3. **性能优化**
   - 图片懒加载
   - 减少DOM操作
   - 优化CSS动画

4. **离线支持**
   - 关键数据本地存储
   - 网络恢复后自动同步
   - 离线状态提示

## Implementation Considerations

1. **性能优化**
   - 使用懒加载减少初始加载时间
   - 实现数据缓存减少请求次数
   - 优化DOM操作提高渲染性能

2. **安全性**
   - 实现数据加密保护敏感信息
   - 防止XSS和CSRF攻击
   - 实现权限控制确保数据安全

3. **可访问性**
   - 遵循WCAG 2.1标准
   - 支持键盘导航
   - 提供适当的颜色对比度

4. **国际化**
   - 支持多语言
   - 考虑不同文化的用户习惯
   - 适配不同地区的日期和时间格式

5. **可扩展性**
   - 采用模块化设计便于功能扩展
   - 使用配置驱动减少硬编码
   - 预留API接口便于未来集成