# 查看健康指导消息 - 用例文档

## 用例基本信息

| 项目 | 内容 |
|------|------|
| **用例名称** | 查看健康指导消息 |
| **简要描述** | 患者通过小程序查看医生发送的健康指导消息，包括查看消息列表、阅读指导详情、查看相关问卷内容，并可对指导内容进行确认和反馈 |
| **参与者** | 患者（主要参与者） |
| **涉众** | 患者、医生、健康指导系统、消息通知系统 |
| **相关用例** | 提交健康问卷、接收健康指导通知、反馈指导效果、查看历史指导记录 |

## 前置条件

• 患者已完成小程序登录认证，具有查看健康指导的权限
• 患者已提交健康问卷，医生已基于问卷提供健康指导
• 系统已成功发送健康指导消息给患者
• 患者与医生之间已建立医患关系（分配关系）
• 患者设备网络连接正常，可以正常访问小程序

## 后置条件

• 患者成功查看健康指导消息，了解医生的专业建议
• 系统记录患者的消息查看行为和阅读时间
• 消息状态更新为"已读"，医生端可以看到患者已查看状态
• 患者可以基于指导内容调整健康管理行为
• 系统为后续的指导效果跟踪提供数据基础

## 基本事件流

1. **患者进入健康指导消息中心**
   - 患者在小程序主页通过底部导航或消息提醒进入健康指导页面
   - 系统显示顶部导航栏，标题为"健康指导"，包含返回按钮和更多操作按钮
   - 页面采用渐变背景设计，提供良好的视觉体验

2. **系统加载并显示指导消息列表**
   - 系统从后台获取发送给当前患者的所有健康指导消息
   - 消息列表按接收时间倒序排列，每条消息包含：
     * 医生头像（显示医生姓氏首字母，渐变色背景）
     * 医生姓名和职称（如"李医生 - 内分泌科主任医师"）
     * 指导内容摘要（显示前两行内容，超出部分用省略号表示）
     * 接收时间（相对时间显示，如"10分钟前"、"昨天 14:30"）
     * 阅读状态标识（未读消息显示蓝色圆点标识）

3. **消息状态标识和视觉效果**
   - 未读消息具有明显的视觉标识：
     * 消息卡片左侧显示蓝色边框
     * 医生姓名旁显示蓝色圆点未读标识
     * 整个消息卡片具有轻微的阴影效果
   - 已读消息显示为普通的白色卡片样式
   - 消息卡片支持悬停效果，提升交互体验

4. **查看健康指导详情**
   - 患者点击具体消息项时，系统添加点击反馈效果
   - 页面跳转到健康指导详情页面（patient-guidance-detail.html）
   - 系统自动将消息标记为已读状态

### 4.1 健康指导详情页面展示

1. **页面加载和导航设置**
   - 系统显示健康指导详情页面，顶部导航显示"健康指导"标题
   - 导航栏包含返回按钮和分享按钮
   - 页面采用渐入动画效果，提升用户体验
   - 整体布局采用卡片式设计，内容层次清晰

2. **医生信息展示**
   - 显示发送指导的医生信息卡片：
     * 医生头像（姓氏首字母，渐变色背景）
     * 医生姓名、科室和职称
     * 指导发送时间（精确到分钟）
   - 信息以卡片形式呈现，带有医生图标标识
   - 采用蓝色主题色，与整体设计风格保持一致

3. **健康指导内容展示**
   - 系统完整显示医生发送的健康指导内容：
     * 保持原有的富文本格式（段落、列表、加粗等）
     * 支持结构化内容显示：问候语、分类建议、结束语
     * 内容采用易读的字体大小和行间距
     * 重要建议使用蓝色高亮显示
   
   - **内容结构化展示**：
     * 问候语部分：显示个性化称呼
     * 健康建议部分：按类别分组显示（饮食、运动、监测、用药等）
     * 数值参数：清晰显示具体的数值建议和单位
     * 注意事项：突出显示重要提醒和复诊安排
     * 结束语：显示医生的关怀和联系提醒

4. **相关问卷信息展示**
   - 在指导内容下方显示相关问卷卡片：
     * 问卷类型和提交时间
     * "查看问卷"按钮，支持查看原始问卷内容
     * 卡片采用浅蓝色背景，与指导内容区分
   - 点击查看问卷按钮，弹出模态框显示完整问卷内容

### 4.2 问卷内容查看功能

1. **问卷模态框展示**
   - 系统弹出问卷查看模态框，占屏幕90%宽度
   - 模态框标题显示问卷类型（如"糖尿病健康问卷"）
   - 右上角提供关闭按钮，支持点击背景关闭
   - 内容区域支持滚动查看完整问卷

2. **问卷内容结构化显示**
   - 逐条显示问卷问题和患者回答：
     * 问题文本使用深色字体，编号清晰
     * 答案内容使用蓝色背景框显示，带有左侧蓝色边框
     * 问题和答案之间有适当的间距，便于阅读
   - 支持长文本答案的完整显示，不截断内容

3. **模态框交互功能**
   - 支持手势滑动关闭模态框
   - 点击模态框背景区域自动关闭
   - 关闭时有平滑的动画过渡效果
   - 模态框打开时，背景页面禁止滚动

5. **指导确认和反馈功能**
   - 页面底部提供固定的操作按钮区域
   - 主要操作按钮："我已了解"或"确认收到"
   - 按钮采用蓝色主题色，具有悬停和点击效果
   - 点击确认后，按钮状态变为"已确认"，颜色变为绿色

6. **确认操作处理**
   - 患者点击确认按钮后，系统执行以下操作：
     * 记录患者的确认时间和行为
     * 向医生端发送患者已查看的反馈信息
     * 更新消息状态为"已确认"
     * 显示确认成功的提示信息
   - 3秒后自动返回消息列表页面

## 备选事件流

### 2a. 无健康指导消息时
2a1. 系统显示空状态页面，提示"暂无消息"
2a2. 显示引导文案："当医生发送健康指导时，您将在这里收到通知"
2a3. 可选择显示相关操作引导，如"去提交健康问卷"

### 2b. 消息加载失败时
2b1. 系统显示网络错误提示："网络连接异常，请检查网络设置"
2b2. 提供"重新加载"按钮，支持手动刷新
2b3. 患者点击重新加载，系统重新获取消息列表
2b4. 如果多次加载失败，提示联系技术支持或稍后重试

### 4a. 指导详情页面加载异常

#### 4a1. 医生信息加载失败
- 如果医生信息获取失败，显示默认头像和"医生"作为默认名称
- 提供重新加载选项，允许用户手动刷新医生信息
- 如果持续失败，不影响指导内容的正常显示

#### 4a2. 指导内容显示异常
- 如果指导内容格式异常，系统进行安全过滤后显示
- 对于损坏的富文本内容，降级为纯文本显示
- 保持内容的可读性，确保患者能够获取核心信息
- 记录内容异常情况，便于后续修复

#### 4a3. 相关问卷加载失败
- 如果问卷数据加载失败，隐藏问卷卡片或显示"问卷暂时无法查看"
- 不影响健康指导内容的正常查看
- 提供"稍后查看"选项，支持用户稍后重试

### 4.2a. 问卷模态框异常情况

#### 4.2a1. 问卷内容不完整
- 如果问卷数据不完整，显示可用的部分内容
- 对于缺失的问题或答案，显示"数据缺失"占位符
- 在模态框顶部显示"部分内容可能缺失"的提示

#### 4.2a2. 模态框显示异常
- 如果模态框无法正常显示，降级为新页面方式查看问卷
- 如果动画效果异常，使用简单的显示/隐藏切换
- 确保用户能够通过某种方式查看问卷内容

### 6a. 确认操作异常

#### 6a1. 网络连接异常
- 如果确认操作时网络异常，显示"确认失败，请重试"提示
- 保持按钮可点击状态，允许用户重新尝试
- 在网络恢复后自动重试确认操作

#### 6a2. 服务器响应异常
- 如果服务器返回错误，显示具体错误信息
- 提供重试选项，支持用户再次确认
- 记录确认失败的情况，便于后续排查

## 补充约束

### 功能性约束

#### 消息列表约束
- 消息列表支持下拉刷新功能，获取最新的健康指导消息
- 未读消息必须有明显的视觉标识：蓝色边框、圆点标识
- 消息严格按接收时间倒序排列，确保最新消息优先显示
- 每个消息项必须包含：医生信息、内容摘要、接收时间、阅读状态
- 消息摘要最多显示两行内容，超出部分用省略号表示
- 消息项点击时提供视觉反馈效果

#### 指导详情页面约束
- 指导内容必须完整显示，保持原有的富文本格式
- 医生信息和发送时间必须准确显示，不允许缺失
- 相关问卷信息必须与指导内容正确关联
- 页面加载时必须有渐入动画效果，提升用户体验
- 支持长文本内容的完整显示，必要时提供滚动功能

#### 问卷查看约束
- 问卷模态框必须支持完整的问卷内容显示
- 问题和答案必须清晰区分，采用不同的视觉样式
- 模态框必须支持多种关闭方式：按钮、背景点击、手势
- 问卷内容必须与原始提交内容完全一致
- 支持长问卷的滚动查看，不限制内容长度

#### 确认反馈约束
- 确认按钮必须固定在页面底部，始终可见
- 确认操作必须有明确的视觉反馈和状态变化
- 确认后必须向医生端发送反馈信息
- 支持确认失败后的重试机制
- 确认成功后必须有明确的成功提示

### 非功能性约束

#### 性能约束
- 消息列表初始加载时间不超过3秒
- 指导详情页面加载时间不超过2秒
- 问卷模态框打开时间不超过1秒
- 页面切换动画时长不超过300毫秒
- 确认操作响应时间不超过2秒
- 图片和富文本内容加载时间不超过5秒

#### 用户体验约束
- 界面滚动流畅，无明显卡顿现象
- 支持不同屏幕尺寸的响应式适配（4.7寸-6.7寸）
- 动画效果流畅自然，不影响用户操作体验
- 在网络较差的情况下，优雅降级显示基本信息
- 所有交互操作必须有即时的视觉反馈
- 文字大小和对比度符合可访问性标准

#### 兼容性约束
- 支持iOS 12.0+和Android 8.0+系统
- 兼容微信小程序基础库2.10.0+
- 支持主流移动设备的屏幕分辨率
- 在低端设备上保持基本功能可用性
- 支持深色模式和浅色模式自动适配

### 业务规则约束

#### 权限和安全约束
- 只显示发送给当前登录患者的健康指导消息
- 消息按医患关系进行权限控制，确保数据安全
- 指导内容和问卷数据仅对授权患者可见
- 所有敏感信息传输必须加密处理
- 患者隐私信息在显示时必须得到适当保护

#### 数据管理约束
- 消息阅读状态需要实时同步到医生端
- 患者确认行为必须完整记录，包括确认时间和内容
- 消息保留期限为90天，超期消息自动归档
- 指导内容和问卷数据需要完整保存，不允许丢失
- 系统需要记录患者的查看行为，用于效果分析

#### 操作规则约束
- 患者查看指导详情后，消息自动标记为已读
- 已确认的指导不允许重复确认，只能查看确认状态
- 指导内容一旦查看，不允许修改或删除
- 问卷内容必须与原始提交内容保持一致
- 确认操作必须由患者本人执行，不允许代理操作

#### 通知和提醒约束
- 新的健康指导消息必须及时推送给患者
- 未读消息数量在应用图标上显示红色徽章
- 重要指导内容需要多次提醒，确保患者及时查看
- 系统需要记录患者的响应时间，用于医生参考
- 长期未查看的消息需要特别提醒机制

## 待解决问题

1. **消息推送机制**：
   - 是否需要实现实时推送功能，确保患者第一时间收到健康指导？
   - 如何处理患者离线时的消息推送和同步？
   - 推送消息的频率和时机如何控制，避免过度打扰？

2. **指导内容个性化**：
   - 是否需要根据患者的阅读习惯调整内容显示格式？
   - 如何支持不同语言和方言的指导内容显示？
   - 是否需要提供语音播报功能，方便视力不便的患者？

3. **交互反馈机制**：
   - 除了简单的确认功能，是否需要更详细的反馈选项？
   - 如何收集患者对指导内容的满意度和有效性反馈？
   - 是否需要支持患者向医生提问或请求澄清？

4. **离线查看支持**：
   - 是否需要支持离线缓存，让患者在无网络时也能查看指导？
   - 离线缓存的数据量和更新策略如何确定？
   - 如何处理离线状态下的确认操作同步？

5. **多媒体内容支持**：
   - 是否需要支持图片、视频或音频形式的健康指导？
   - 如何优化多媒体内容的加载和显示体验？
   - 多媒体内容的存储和传输成本如何控制？

6. **家属代理查看**：
   - 是否需要支持家属代理查看患者的健康指导？
   - 如何在保护患者隐私的前提下，允许必要的家属参与？
   - 代理查看的权限范围和审批流程如何设计？

7. **指导效果跟踪**：
   - 如何设计患者执行指导建议的跟踪机制？
   - 是否需要定期提醒患者按照指导内容执行健康管理？
   - 如何量化评估健康指导的实际效果？

8. **紧急指导处理**：
   - 对于紧急或重要的健康指导，如何确保患者及时查看？
   - 是否需要设计特殊的提醒机制和显示样式？
   - 紧急指导的确认要求是否需要更加严格？

## 相关图

### 界面流程图
```
患者小程序主页(patient-interface.html)
    ↓ [点击健康指导入口]
健康指导消息列表(patient-messages.html)
    ↓ [点击具体消息]
健康指导详情页面(patient-guidance-detail.html)
    ↓ [点击查看问卷]          ↓ [点击确认按钮]
问卷查看模态框                确认成功提示
    ↓ [关闭模态框]            ↓ [自动返回]
健康指导详情页面              消息列表页面
```

### 消息状态流转图
```
医生发送健康指导 → 系统生成消息通知 → 患者接收消息推送
                                    ↓
                              消息列表显示未读状态
                                    ↓
                              患者点击查看详情 → 消息标记为已读
                                    ↓
                              患者查看指导内容 → 点击确认按钮
                                    ↓
                              消息状态更新为已确认 → 医生端收到反馈
```

### 数据流图
```
医生端健康指导 → [发送] → 消息服务 → [推送] → 患者端消息列表
                                        ↓
患者端详情页面 ← [查看] ← 指导内容服务 ← [获取] ← 消息服务
        ↓
    [确认操作] → 反馈服务 → [通知] → 医生端统计
```

## 技术实现要点

### 前端实现（基于实际代码）

#### 页面结构和样式
- **响应式布局**：使用Tailwind CSS框架，支持不同屏幕尺寸适配
- **卡片式设计**：消息列表、医生信息、指导内容分别采用卡片布局
- **渐进式加载**：使用CSS动画（fade-in）实现页面元素的渐进显示
- **交互反馈**：消息项悬停效果、点击动画、状态切换动画

#### 核心JavaScript功能模块

##### 消息列表管理模块
```javascript
// 消息列表数据结构
const guidanceMessages = [
    {
        id: 'guidance-1',
        doctorName: '李医生',
        doctorTitle: '内分泌科主任医师',
        content: '根据您的糖尿病健康问卷和体检报告，我为您提供了一些健康建议...',
        sendTime: '2023-07-16 10:30',
        relativeTime: '10分钟前',
        isRead: false
    }
];

// 打开健康指导详情
function openGuidance(guidanceId) {
    // 标记消息为已读
    markAsRead(guidanceId);
    // 跳转到详情页面
    window.location.href = `patient-guidance-detail.html?id=${guidanceId}`;
}

// 标记消息为已读
function markAsRead(guidanceId) {
    // 更新本地状态
    // 发送已读状态到服务器
}
```

##### 指导详情展示模块
```javascript
// 显示问卷模态框
function showQuestionnaire() {
    const modal = document.getElementById('questionnaireModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// 关闭模态框
function closeModal() {
    const modal = document.getElementById('questionnaireModal');
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
}

// 确认已了解指导
function confirmUnderstanding() {
    const button = document.querySelector('.primary-button');
    
    // 更新按钮状态
    button.innerHTML = '<i class="fas fa-check mr-2"></i>已确认';
    button.style.background = '#4caf50';
    button.disabled = true;
    
    // 发送确认信息
    sendConfirmation();
    
    // 延时返回列表
    setTimeout(() => {
        window.location.href = 'patient-messages.html';
    }, 3000);
}
```

##### 数据同步模块
```javascript
// 向医生端发送患者行为反馈
function sendPatientFeedback(action, data) {
    if (window.parent) {
        window.parent.postMessage({
            type: 'patientAction',
            data: { 
                action: action,
                ...data
            }
        }, '*');
    }
}

// 接收来自医生端的消息更新
window.addEventListener('message', function(event) {
    if (event.data.type === 'updateFromDoctor') {
        handleDoctorUpdate(event.data.data);
    }
});
```

### 后端接口设计

#### 核心API接口

##### 健康指导消息接口
```javascript
// 获取患者的健康指导消息列表
GET /api/patient/guidance/messages
Query Parameters: {
    page: number,
    pageSize: number,
    status: 'all|unread|read'
}
Response: {
    messages: [
        {
            id: "string",
            doctorInfo: {
                doctorId: "string",
                name: "string",
                title: "string",
                avatar: "string"
            },
            content: "string", // 指导内容摘要
            fullContent: "string", // 完整指导内容
            sendTime: "datetime",
            isRead: "boolean",
            isConfirmed: "boolean",
            relatedQuestionnaire: {
                questionnaireId: "string",
                type: "string",
                submitTime: "datetime"
            }
        }
    ],
    pagination: {
        total: "number",
        page: "number",
        pageSize: "number"
    }
}

// 获取特定健康指导详情
GET /api/patient/guidance/{guidanceId}
Response: {
    guidance: {
        id: "string",
        doctorInfo: {...},
        content: "string", // 富文本内容
        sendTime: "datetime",
        isRead: "boolean",
        isConfirmed: "boolean",
        relatedQuestionnaire: {
            questionnaireId: "string",
            questions: [
                {
                    questionText: "string",
                    answer: "string"
                }
            ]
        }
    }
}
```

##### 患者反馈接口
```javascript
// 标记指导为已读
PUT /api/patient/guidance/{guidanceId}/read
Request: {
    readTime: "datetime"
}
Response: {
    success: true,
    message: "已标记为已读"
}

// 确认已了解指导
PUT /api/patient/guidance/{guidanceId}/confirm
Request: {
    confirmTime: "datetime",
    feedback: "string" // 可选的反馈内容
}
Response: {
    success: true,
    message: "确认成功",
    confirmId: "string"
}
```

### 数据结构设计

#### 健康指导消息数据结构
```json
{
    "guidanceId": "string",
    "patientId": "string",
    "doctorId": "string",
    "questionnaireId": "string",
    "guidanceContent": {
        "title": "string",
        "htmlContent": "string", // 富文本内容
        "plainContent": "string", // 纯文本备份
        "summary": "string", // 内容摘要
        "contentType": "html|markdown|plain"
    },
    "doctorInfo": {
        "name": "string",
        "title": "string",
        "department": "string",
        "avatar": "string"
    },
    "messageStatus": {
        "sendTime": "datetime",
        "readTime": "datetime",
        "confirmTime": "datetime",
        "isRead": "boolean",
        "isConfirmed": "boolean"
    },
    "relatedData": {
        "questionnaireId": "string",
        "questionnaireType": "string",
        "questionnaireSubmitTime": "datetime"
    },
    "metadata": {
        "contentLength": "number",
        "priority": "normal|high|urgent",
        "category": "string"
    }
}
```

#### 患者行为记录数据结构
```json
{
    "actionId": "string",
    "patientId": "string",
    "guidanceId": "string",
    "actionType": "view|read|confirm|feedback",
    "actionTime": "datetime",
    "actionData": {
        "duration": "number", // 查看时长（秒）
        "scrollDepth": "number", // 滚动深度百分比
        "interactionCount": "number", // 交互次数
        "feedback": "string" // 反馈内容
    },
    "deviceInfo": {
        "platform": "string",
        "version": "string",
        "screenSize": "string"
    }
}
```

### 页面路由和导航

#### 主要页面路由
- **消息列表页面**：`patient-messages.html`
  * 功能：显示健康指导消息列表，支持查看和筛选

- **指导详情页面**：`patient-guidance-detail.html?id={guidanceId}`
  * 查询参数：id（指导消息ID）
  * 功能：显示完整的健康指导内容和相关问卷

#### 页面跳转逻辑
```javascript
// 消息列表 → 指导详情
function openGuidance(guidanceId) {
    window.location.href = `patient-guidance-detail.html?id=${guidanceId}`;
}

// 返回导航处理
function goBack() {
    if (window.history.length > 1) {
        window.history.back();
    } else {
        window.location.href = 'patient-interface.html';
    }
}
```

### 错误处理和用户反馈

#### 错误处理策略
```javascript
// 统一错误处理
function handleError(error, context) {
    console.error(`Error in ${context}:`, error);
    
    switch(error.type) {
        case 'network':
            showToast('网络连接异常，请检查网络设置', 'error');
            break;
        case 'permission':
            showToast('权限不足，请重新登录', 'error');
            break;
        case 'data':
            showToast('数据加载失败，请重试', 'warning');
            break;
        default:
            showToast('操作失败，请重试', 'error');
    }
}

// 用户反馈提示
function showToast(message, type = 'info') {
    // 创建并显示提示消息
    // 支持不同类型的样式：info, success, warning, error
}
```

#### 加载状态管理
```javascript
// 页面加载状态
function setLoadingState(isLoading) {
    const loadingElement = document.getElementById('loading');
    if (isLoading) {
        loadingElement.style.display = 'flex';
    } else {
        loadingElement.style.display = 'none';
    }
}

// 内容加载动画
function animateContentLoad() {
    const elements = document.querySelectorAll('.fade-in');
    elements.forEach((element, index) => {
        setTimeout(() => {
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, index * 100);
    });
}
```

这个用例文档详细描述了患者端"查看健康指导消息"功能的完整流程，包括用户交互、系统响应、异常处理和技术实现细节，与项目中的实际实现保持一致，为开发团队提供了全面的功能规范和实现指导。